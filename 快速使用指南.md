# HackRF MQTT 数据传输系统 - 快速使用指南

## 1. 系统要求

### 硬件要求
- HackRF One 设备
- USB 3.0 接口（推荐）
- 至少 4GB RAM
- 网络连接

### 软件要求
- Linux (Ubuntu 18.04+) 或 Windows 10+
- CMake 3.10+
- C++17 编译器 (GCC 7+ 或 MSVC 2017+)
- libhackrf 开发库
- libmosquittopp 开发库

## 2. 快速安装

### Ubuntu/Debian 系统
```bash
# 安装依赖
sudo apt update
sudo apt install -y cmake build-essential pkg-config
sudo apt install -y libhackrf-dev libmosquittopp-dev
sudo apt install -y git

# 克隆项目（如果从git获取）
# git clone <repository-url>
cd hackrf_one_mqtt

# 编译项目
mkdir build && cd build
cmake ..
make -j$(nproc)
```

### Windows 系统
```powershell
# 使用 vcpkg 安装依赖
vcpkg install hackrf mosquitto[cpp]

# 使用 Visual Studio 或命令行编译
mkdir build
cd build
cmake .. -DCMAKE_TOOLCHAIN_FILE=[vcpkg root]/scripts/buildsystems/vcpkg.cmake
cmake --build . --config Release
```

## 3. 配置文件设置

编辑 `config.json` 文件：

```json
{
  "hackrf": {
    "center_frequency_hz": 2400000000,
    "sample_rate_hz": 2000000,
    "baseband_filter_bandwidth_hz": 1750000,
    "lna_gain": 32,
    "vga_gain": 24
  },
  "mqtt": {
    "broker_host": "localhost",
    "broker_port": 1883,
    "client_id": "hackrf_collector_001",
    "topic": "sdr/hackrf/raw_iq",
    "control_topic": "sdr/hackrf/control",
    "qos": 0,
    "keepalive_s": 60,
    "username": "",
    "password": ""
  },
  "data_queue_max_size": 100,
  "log_level": "INFO"
}
```

### 关键参数说明

| 参数 | 说明 | 推荐值 |
|------|------|--------|
| center_frequency_hz | 中心频率(Hz) | 2400000000 (2.4GHz) |
| sample_rate_hz | 采样率(Hz) | 2000000 (2MS/s) |
| lna_gain | LNA增益(dB) | 16-40 |
| vga_gain | VGA增益(dB) | 16-62 |
| broker_host | MQTT代理地址 | localhost |
| topic | 数据发布主题 | sdr/hackrf/raw_iq |

## 4. 启动 MQTT 代理

### 使用 Mosquitto
```bash
# Ubuntu/Debian
sudo apt install mosquitto mosquitto-clients
sudo systemctl start mosquitto
sudo systemctl enable mosquitto

# 测试连接
mosquitto_pub -h localhost -t test/topic -m "Hello MQTT"
mosquitto_sub -h localhost -t test/topic
```

### 使用 Docker
```bash
docker run -it -p 1883:1883 -p 9001:9001 eclipse-mosquitto
```

## 5. 运行程序

```bash
# 在 build 目录下
./hackrf_mqtt_transmitter

# 或指定配置文件
./hackrf_mqtt_transmitter ../config.json
```

### 预期输出
```
[2024-01-01 12:00:00.123] [INFO] Configuration loaded from config.json
[2024-01-01 12:00:00.124] [INFO] Mosquitto library initialized.
[2024-01-01 12:00:00.125] [INFO] HackRF device opened successfully.
[2024-01-01 12:00:00.126] [INFO] HackRF frequency set to 2400.0 MHz.
[2024-01-01 12:00:00.127] [INFO] HackRF sample rate set to 2.0 MS/s.
[2024-01-01 12:00:00.128] [INFO] MQTT: Attempting to connect to localhost:1883...
[2024-01-01 12:00:00.129] [INFO] MQTT: Connected to broker successfully.
[2024-01-01 12:00:00.130] [INFO] HackRF RX streaming started.
[2024-01-01 12:00:00.131] [INFO] MQTT Publisher thread started.
```

## 6. 远程控制

### 暂停数据采集
```bash
mosquitto_pub -h localhost -t sdr/hackrf/control -m "PAUSE"
```

### 恢复数据采集
```bash
mosquitto_pub -h localhost -t sdr/hackrf/control -m "RESUME"
```

## 7. 数据订阅与处理

### 基本数据订阅
```bash
# 订阅原始IQ数据（二进制数据）
mosquitto_sub -h localhost -t sdr/hackrf/raw_iq > data.bin
```

### Python 数据处理示例
```python
import paho.mqtt.client as mqtt
import numpy as np

def on_message(client, userdata, message):
    # 解析IQ数据
    raw_data = message.payload
    iq_data = np.frombuffer(raw_data, dtype=np.uint8)
    
    # 转换为复数 (I + jQ)
    i_data = (iq_data[0::2].astype(np.float32) - 128) / 128.0
    q_data = (iq_data[1::2].astype(np.float32) - 128) / 128.0
    complex_data = i_data + 1j * q_data
    
    print(f"Received {len(complex_data)} samples")
    # 在此处添加您的信号处理代码

client = mqtt.Client()
client.on_message = on_message
client.connect("localhost", 1883, 60)
client.subscribe("sdr/hackrf/raw_iq")
client.loop_forever()
```

## 8. 常见问题解决

### HackRF 设备问题
```bash
# 检查设备连接
hackrf_info

# 检查USB权限 (Linux)
sudo usermod -a -G plugdev $USER
# 重新登录或重启
```

### MQTT 连接问题
```bash
# 测试MQTT连接
mosquitto_pub -h localhost -t test -m "test" -d

# 检查防火墙
sudo ufw allow 1883
```

### 性能问题
- **数据丢失**: 增加 `data_queue_max_size`
- **内存占用高**: 减少队列大小或采样率
- **CPU占用高**: 降低采样率或增加发布间隔

## 9. 监控与调试

### 实时监控
```bash
# 监控日志
tail -f /var/log/hackrf_mqtt.log

# 监控MQTT流量
mosquitto_sub -h localhost -t 'sdr/hackrf/+' -v
```

### 性能统计
```bash
# 查看进程资源使用
top -p $(pgrep hackrf_mqtt_transmitter)

# 查看网络流量
iftop -i eth0
```

## 10. 应用场景配置

### 2.4GHz Wi-Fi 监测
```json
{
  "hackrf": {
    "center_frequency_hz": 2437000000,
    "sample_rate_hz": 20000000,
    "baseband_filter_bandwidth_hz": 15000000,
    "lna_gain": 24,
    "vga_gain": 20
  }
}
```

### 433MHz IoT 监测
```json
{
  "hackrf": {
    "center_frequency_hz": 433920000,
    "sample_rate_hz": 2000000,
    "baseband_filter_bandwidth_hz": 1000000,
    "lna_gain": 32,
    "vga_gain": 28
  }
}
```

### 915MHz ISM 频段
```json
{
  "hackrf": {
    "center_frequency_hz": 915000000,
    "sample_rate_hz": 4000000,
    "baseband_filter_bandwidth_hz": 3000000,
    "lna_gain": 28,
    "vga_gain": 24
  }
}
```

## 11. 安全注意事项

⚠️ **重要提醒**:
- 确保遵守当地无线电法规
- 不要监听加密或私人通信
- 注意功率设置，避免设备过热
- 定期检查天线连接

## 12. 技术支持

### 日志级别设置
- `DEBUG`: 详细调试信息
- `INFO`: 一般运行信息（推荐）
- `WARNING`: 警告信息
- `ERROR`: 仅错误信息

### 故障排除步骤
1. 检查硬件连接
2. 验证配置文件语法
3. 测试MQTT连接
4. 查看程序日志
5. 检查系统资源

---

**快速参考**:
- 默认MQTT端口: 1883
- 默认采样率: 2MS/s
- 默认中心频率: 2.4GHz
- 数据格式: 8位IQ交替存储
- 控制命令: PAUSE/RESUME

更多详细信息请参考 `HackRF_MQTT技术文档_代码详解.md`
